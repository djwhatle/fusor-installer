#!/bin/bash

if [ "$(id -u)" != "0" ]; then
   echo "This script must be run as root"
   exit 1
fi

h=\\-h\\b
fusor-setup $@
if [ $? != 0 ]; then
  echo "fusor-setup did not run properly."
  echo "Please correct the problem and try again."
  exit 2
elif [[ $@ == *"--help"* ]] || [[ $@ =~ $h ]] || [[ $@ == *"--full-help"* ]]; then
  exit 0
fi

#kafo nukes the file permissions whatever we make them.
if [[ $@ != *"--devel_env"* ]]; then
  chmod 660 /etc/fusor-installer/fusor-installer.answers.yaml
  chown root:foreman /etc/fusor-installer/fusor-installer.answers.yaml
fi

echo "Finished running fusor-setup."
echo "Now running foreman-installer."

foreman-installer --scenario fusor

if [ $? != 0 ]; then
  echo "foreman-installer did not run properly."
  echo "Please correct the problem and try again."
  exit 3
fi

echo "Finished running foreman-installer."
echo "Now running rake fusor:setup."

if [[ $@ == *"--devel_env"* ]]; then
  echo "Setting up file permission for development environment."
  setfacl -m u:vagrant:r /var/log/messages
  setfacl -m u:vagrant:rx /var/log/foreman-proxy
else
  echo "Setting up file permission for production environment."
  setfacl -m u:foreman:r /var/log/messages
fi

if [[ $@ == *"--devel_env"* ]]; then
  while [[ $# > 0 ]]; do
    i="$1"
    case $i in
      --deployment_dir=*)
      deployment_dir="${i#*=}"
      shift
      ;;
      --deployment_dir)
      deployment_dir="$2"
      shift
      ;;
      *)

      ;;
    esac
    shift
  done

  if [[ -z "$deployment_dir" ]]; then
    deployment_dir=/home/vagrant
  fi

  su - vagrant -c /bin/bash --login -c "cd ${deployment_dir}/foreman && rvm use 2.2.4 >/dev/null 2>&1 && rake fusor:setup >/dev/null 2>&1"
  if [ $? != 0 ]; then
    echo "rake fusor:setup did not run successfully"
    echo "Please run it manually to determine the problem."
    exit 4
  else
    echo "Finished running rake fusor:setup."
    echo "Installation Complete!"
  fi
else
  foreman-rake fusor:setup >/dev/null 2>&1
  if [ $? != 0 ]; then
    echo "foreman-rake fusor:setup did not run successfully"
    echo "Please run it manually to determine the problem."
    exit 5
  else
    echo "Finished running foreman-rake fusor:setup."
    echo "Installation Complete!"
  fi
fi

